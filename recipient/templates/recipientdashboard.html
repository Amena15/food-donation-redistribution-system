{% extends 'base.html' %}

{% block title %}Recipient Dashboard | Share Food, Share Hope{% endblock %}

{% block page_subtitle %}Find food assistance and resources near you.{% endblock %}

{% block extra_css %}
<style>
    /* Map/Donor List Toggle Styles */
    .view-toggle {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
        background: white;
    }
    
    .view-toggle-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        background: transparent;
        cursor: pointer;
        text-align: center;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .view-toggle-btn.active {
        background: var(--primary-color);
        color: #1c1919a5;
    }
    
    /* Donor List Styles */
    .donor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    .donor-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .donor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }

    .distance-badge {
        background: #4CAF50;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
    }

    .donor-details p {
        margin: 8px 0;
        color: #555;
    }

    .pickup-info {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px dashed #e0e0e0;
    }

    .pickup-info h5 {
        margin-bottom: 5px;
        color: #333;
    }

    .donor-actions {
        margin-top: 15px;
        text-align: right;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

    .empty-state i {
        font-size: 3em;
        color: #ccc;
        margin-bottom: 15px;
    }

    .empty-state h4 {
        margin: 10px 0;
        color: #333;
    }

    .empty-state p {
        color: #666;
        margin-bottom: 20px;
    }
    
    /* Map Modal Styles */
    .map-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }

    .map-modal-content {
        background-color: #fff;
        margin: 2% auto;
        padding: 20px;
        border-radius: 8px;
        width: 95%;
        height: 90%;
        position: relative;
    }

    .modal-map-container {
        height: calc(100% - 60px);
        width: 100%;
    }
    
    /* Hidden class for toggling */
    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="cards-row">
        <div class="card stat-card">
            <div class="stat-icon primary-icon"><i class="fas fa-clipboard-list"></i></div>
            <div class="stat-info">
                <h3>{{ total_requests }}</h3>
                <p>Total Requests</p>
            </div>
        </div>
        
        <div class="card stat-card">
            <div class="stat-icon secondary-icon"><i class="fas fa-calendar-check"></i></div>
            <div class="stat-info">
                <h3>{{ approved_requests }}</h3>
                <p>Approved Requests</p>
            </div>
        </div>
        
        <div class="card stat-card">
            <div class="stat-icon info-icon"><i class="fas fa-store"></i></div>
            <div class="stat-info">
                <h3>{{ pending_requests }}</h3>
                <p>Pending Requests</p>
            </div>
        </div>
        
        <div class="card stat-card">
            <div class="stat-icon success-icon"><i class="fas fa-box-open"></i></div>
            <div class="stat-info">
                <h3>{{ completed_requests }}</h3>
                <p>Completed Requests</p>
            </div>
        </div>
    </div>
    
    <!-- Nearby Donors Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Food Donors Near You</h3>
            <div class="card-actions">
                <div class="view-toggle">
                    <button id="map-view-btn" class="view-toggle-btn active">
                        <i class="fas fa-map"></i> Map View
                    </button>
                    <button id="list-view-btn" class="view-toggle-btn">
                        <i class="fas fa-list"></i> List View
                    </button>
                </div>
                <button id="refresh-map" class="btn-custom-sm">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button id="locate-me" class="btn-custom-sm">
                    <i class="fas fa-location-arrow"></i> My Location
                </button>
                <button id="show-modal-map" class="btn-custom-sm">
                    <i class="fas fa-expand"></i> Full Screen
                </button>
            </div>
        </div>
        
        <!-- Map View -->
        <div id="map-view" class="map-container">
            <div class="map-container" id="donors-map"></div>
        </div>
        
        <!-- List View -->
        <div id="list-view" class="hidden">
            <div class="donor-list-container">
                {% if nearby_donors %}
                    <div class="donor-grid">
                        {% for donor in nearby_donors %}
                        <div class="donor-card">
                            <div class="donor-header">
                                <h4>{{ donor.location_name }}</h4>
                                <span class="distance-badge">{{ donor.distance|floatformat:1 }} miles away</span>
                            </div>
                            
                            <div class="donor-details">
                                <p><i class="fas fa-user"></i> {{ donor.get_full_name }}</p>
                                <p><i class="fas fa-phone"></i> {{ donor.phone_number|default:"Phone not provided" }}</p>
                                
                                {% if donor.pickup_instructions %}
                                <div class="pickup-info">
                                    <h5>Pickup Instructions:</h5>
                                    <p>{{ donor.pickup_instructions }}</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="donor-actions">
                                <a href="{% url 'recipient:request_donation' donor.id %}" class="btn-custom-sm">
                                    <i class="fas fa-utensils"></i> Request Food
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <h4>No nearby donors found</h4>
                        <p>We couldn't find any active food donors within 10 miles of your location.</p>
                        <a href="{% url 'recipient:profile' %}" class="btn-custom">
                            <i class="fas fa-map-marked-alt"></i> Update My Location
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Upcoming Pickups -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">My Upcoming Food Pickups</h3>
            <a href="{% url 'recipient:pickups_list' %}" class="card-action">View All</a>
        </div>
        
        <div class="table-container">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Food Source</th>
                        <th>Items</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pickup in upcoming_pickups %}
                    <tr>
                        <td>{{ pickup.request.donation.donor.get_full_name }}</td>
                        <td>{{ pickup.request.donation.title }}</td>
                        <td>{{ pickup.scheduled_time|date:"M d, Y" }}</td>
                        <td>{{ pickup.scheduled_time|time }}</td>
                        <td>
                            <span class="status status-{{ pickup.request.status|lower }}">
                                {{ pickup.request.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'recipient:pickup_detail' pickup.id %}">
                                <i class="fas fa-eye action-btn" title="View Details"></i>
                            </a>
                            {% if pickup.request.status == 'approved' %}
                            <a href="{% url 'recipient:manage_pickup' pickup.id %}">
                                <i class="fas fa-calendar-alt action-btn" title="Reschedule"></i>
                            </a>
                            {% endif %}
                            <a href="{% url 'recipient:cancel_request' pickup.request.id %}">
                                <i class="fas fa-times action-btn" title="Cancel"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center;">No upcoming pickups scheduled</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Two-column layout -->
    <div class="grid-2">
        <!-- My Food Requests -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">My Food Requests</h3>
                <a href="{% url 'recipient:browse_donations' %}" class="card-action">New Request</a>
            </div>
            
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Request Type</th>
                            <th>Details</th>
                            <th>Date Submitted</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for request in food_requests %}
                        <tr>
                            <td>Food Donation</td>
                            <td>{{ request.donation.title }}</td>
                            <td>{{ request.requested_at|date:"M d, Y" }}</td>
                            <td>
                                <span class="status status-{{ request.status|lower }}">
                                    {{ request.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'recipient:request_detail' request.id %}">
                                    <i class="fas fa-eye action-btn" title="View Details"></i>
                                </a>
                                {% if request.status == 'pending' %}
                                <a href="{% url 'recipient:cancel_request' request.id %}">
                                    <i class="fas fa-times action-btn" title="Cancel"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" style="text-align: center;">No food requests yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Recent Notifications -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Notifications</h3>
                <a href="{% url 'recipient:notification_list' %}" class="card-action">View All</a>
            </div>
            
            {% for notification in recent_notifications %}
            <div class="notification-item {% if not notification.is_read %}unread{% endif %}">
                <div class="notification-content">
                    <p>{{ notification.message }}</p>
                    <small>{{ notification.created_at|timesince }} ago</small>
                </div>
                {% if not notification.is_read %}
                <form method="post" action="{% url 'recipient:mark_notification_read' notification.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-custom-sm">Mark Read</button>
                </form>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-bell"></i>
                <h4>No notifications</h4>
                <p>You don't have any notifications yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Modal Map -->
    <div id="map-modal" class="map-modal">
        <div class="map-modal-content">
            <span class="close-map">&times;</span>
            <div class="map-header">
                <h3>Food Donors Map</h3>
                <div class="map-controls">
                    <button id="modal-locate-me" class="btn-custom-sm">
                        <i class="fas fa-location-arrow"></i> My Location
                    </button>
                    <button id="modal-refresh-map" class="btn-custom-sm">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="modal-map-container" id="modal-map"></div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle between map and list views
    document.addEventListener('DOMContentLoaded', function() {
        const mapViewBtn = document.getElementById('map-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const mapView = document.getElementById('map-view');
        const listView = document.getElementById('list-view');
        
        mapViewBtn.addEventListener('click', function() {
            this.classList.add('active');
            listViewBtn.classList.remove('active');
            mapView.classList.remove('hidden');
            listView.classList.add('hidden');
        });
        
        listViewBtn.addEventListener('click', function() {
            this.classList.add('active');
            mapViewBtn.classList.remove('active');
            listView.classList.remove('hidden');
            mapView.classList.add('hidden');
        });
        
        // Modal map functionality
        const showModalMapBtn = document.getElementById('show-modal-map');
        const mapModal = document.getElementById('map-modal');
        const closeMap = document.querySelector('.close-map');
        
        showModalMapBtn.addEventListener('click', function() {
            mapModal.style.display = 'block';
            // You might need to reinitialize the map here if needed
        });
        
        closeMap.addEventListener('click', function() {
            mapModal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target == mapModal) {
                mapModal.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}